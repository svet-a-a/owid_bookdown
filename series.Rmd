--- 
title: "L’évolution de la population, la production de nourriture et la consommation d’énergie à l’échelle mondiale"
author: "Simon et Svetlana"
date: "`r Sys.Date()`"
site: bookdown::bookdown_site
# output: bookdown::gitbook
documentclass: book
bibliography: [book.bib, packages.bib]
biblio-style: apalike
link-citations: yes
github-repo: openscapes/series
description: "A mini bookdown tutorial book on how to make bookdown books."
---

# Description des données {#welcome}

3 fichiers :

1. Consommation d'énergie
1. production de la nourriture
1. Population

<!--chapter:end:index.Rmd-->

# Préparation des données 

## Bases de données a l'echelle mondiale
```{r IMORT, message=FALSE, include=FALSE, results='hide'}

library(flexdashboard)
library(tidyverse)
library(readxl)
library(tidyselect)
library(countrycode)

```


```{r WORLD, echo=TRUE, warning=FALSE, results='hide'}

energy_world<-read_delim("owid-energy-data__OWID.csv") |> 
  select(1:3, ends_with("consumption")) |> 
  filter(year>1964 & year< 2020) |> 
  filter(country=="World")|> 
  select(3:5,7,8,10,11,12,15,16) |> 
  pivot_longer(cols = 2:10,
               names_to = "energy_source",
               values_to = "energy_source_consumption") |> 
  replace_na(list(energy_source_consumption = 0)) |> 
  mutate(energy_type = if_else(condition = str_detect(energy_source, "coal")|
                                 str_detect(energy_source, "gas")|
                                 str_detect(energy_source, "oil"),
                               true = "fossil_fuel_consumption",
                               false = "low_carbon_consumption"), 
         .after = energy_source)

write_delim(energy_world, "energy_world.csv", delim = ",")
  

food_world<-read_delim("Production_Crops_Livestock_E_All_Data.csv") |> 
  select(!ends_with("F")) |> 
  rename_with(~ str_remove(., "Y"), 8:67) |> 
# names(food) <- sub("Y", "", names(food))
  filter(str_detect(Item, "Total")|str_detect(Item, "Primary")) |>
  #select(Element) |> distinct()
  filter(Element=="Production") |> 
  pivot_longer(cols = 8:67,
               names_to = "year",
               values_to = "production") |> 
  filter(Area == "World") |> 
  mutate(year=as.numeric(year)) |> 
  mutate(production = production/1000000) |> 
  select(4, 7:9)

write_delim(food_world, "food_world.csv", delim = ",")

population_world<-read_excel("WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES_UN.xlsx", 
                       skip=16, na="...") |> 
  rename(region = 3) |> 
  filter(region=="WORLD") |> 
  pivot_longer(cols = 8:78,
               names_to = "year",
               values_to = "population_total") |> 
  mutate(year = as.numeric(year)) |> 
  mutate(population_total = as.numeric(population_total)/1000000) |> 
  select(8,9)

write_delim(population_world, "population_world.csv", delim = ",")


```

## Bases de données par pays et continent et par pays

```{r COUNTRY, echo=TRUE, warning=FALSE, results='hide'}

energy_continent<-read_delim("owid-energy-data__OWID.csv") |> 
  select(1:3, ends_with("consumption")) |> 
  filter(year>1964 & year< 2020) |> 
  select(2:5,7,8,10,11,12,15,16) |> 
  pivot_longer(cols = 3:11,
               names_to = "energy_source",
               values_to = "energy_source_consumption") |> 
  replace_na(list(energy_source_consumption = 0)) |> 
  mutate(energy_type = if_else(condition = str_detect(energy_source, "coal")|
                                 str_detect(energy_source, "gas")|
                                 str_detect(energy_source, "oil"),
                               true = "fossil_fuel_consumption",
                               false = "low_carbon_consumption"), 
         .after = energy_source) |>
  mutate(iso_code=countrycode(country, 
                              origin = "country.name",
                              destination = "iso3c"),
         .before = country) |>
  drop_na(iso_code) |> 
  select(1,3:6)
    
guess_encoding("Production_Crops_Livestock_E_All_Data.csv")

food_continent<-read_delim("Production_Crops_Livestock_E_All_Data.csv",
                           locale = locale(encoding = "ISO-8859-1")) |> 
  select(!ends_with("F")) |> 
  rename_with(~ str_remove(., "Y"), 8:67) |> 
  filter(str_detect(Item, "Total")|str_detect(Item, "Primary")) |>
  filter(Element=="Production") |> 
  pivot_longer(cols = 8:67,
               names_to = "year",
               values_to = "production") |> 
  mutate(year=as.numeric(year)) |> 
  mutate(production = production/1000000) |> 
  rename(country = 2) |> 
  filter(!str_detect(country, "China,")) |> 
  #filter(continent=="Asia") |> 
  #filter(str_detect(country,"China")) |> 
  #group_by(country, Item) |> 
  #summarise(total = sum(production)) 
  mutate(iso_code = countrycode(country, 
                               origin = "country.name", 
                               destination = "iso3c"),
        .before = country) |>
  drop_na(iso_code) |> 
  select(2,5,9,10)

population_continent<-read_excel("WPP2019_POP_F01_1_TOTAL_POPULATION_BOTH_SEXES_UN.xlsx", 
                       skip=16, na="...") |> 
  rename(country = 3) |> 
  pivot_longer(cols = 8:78,
               names_to = "year",
               values_to = "population_total") |> 
  mutate(year = as.numeric(year)) |> 
  mutate(population_total = as.numeric(population_total)/1000000) |> 
  filter(!str_detect(country, "China,")) |>
  filter(!str_detect(country, "excluding")) |> 
  mutate(iso_code = countrycode(country, 
                                origin = "country.name", 
                                destination = "iso3c"),
         .before = country) |> 
  drop_na(iso_code) |> 
  select(3,9,10)

```


## Jointure des bases de données

```{r JOIN, echo=TRUE, warning=FALSE, results='hide'}

df_country<-full_join(energy_continent, food_continent, by = c("iso_code" = "iso_code", "year" = "year")) |> 
  full_join(population_continent, by = c("iso_code" = "iso_code",
                                         "year" = "year")) |> 
  mutate(country = countrycode(iso_code, origin = "iso3c", destination = "country.name"), .before = year) |> 
  filter(!is.na(iso_code)) |> 
  mutate(continent=countrycode(iso_code, 
                               origin = "iso3c", 
                               destination = "continent"),
                               .after = country)

write_delim(df_country, "owid_country.csv", delim = ",")

```

## Base de données avec de totaux par pays

```{r JOIN TOTALS, echo=TRUE, warning=FALSE, results='hide'}

energy_total<-energy_continent |> 
  group_by(iso_code, year) |> 
  summarise(energy_total = sum(energy_source_consumption, na.rm=TRUE))

food_total<-food_continent |> 
  group_by(iso_code, year) |> 
  summarise(production_total = sum(production, na.rm=TRUE))

df_total<-full_join(energy_total, food_total, by = c("iso_code" = "iso_code", "year" = "year")) |> 
  full_join(population_continent, by = c("iso_code" = "iso_code",
                                         "year" = "year")) |> 
  mutate(country = countrycode(iso_code, origin = "iso3c", destination = "country.name"), .before = year)

write_delim(df_total, "owid_total.csv", delim = ",")

```


<!--chapter:end:Preparation_donnees.Rmd-->



```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
#knitr::opts_chunk$set(include = FALSE)

library(flexdashboard)
library(tidyverse)
library(readxl)
library(tidyselect)
library(countrycode)

# chargement des  tableaux 

energy_world<-read_delim("energy_world.csv") 
 
food_world<-read_delim("food_world.csv")

population_world<-read_delim("population_world.csv")

df_country<-read_delim("owid_country.csv")
```

# Analyse mondiale

### Consommation d'energie par source et par source 

```{r echo=FALSE, warning=FALSE}

ggplot(energy_world)+
  aes(year, energy_source_consumption, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,10)) +
  scale_y_continuous(limits = c(0, 170000),
                     breaks = seq(0,170000,10000))+
  theme_dark()


```

### Consommation d'energie parsource et par type 

```{r echo=FALSE}

ggplot(energy_world)+
  aes(year, energy_source_consumption, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source et par type", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,10)) +
  scale_y_continuous(limits = c(0, 150000),
                     breaks = seq(0,150000,10000))+
  theme_dark()+
  facet_grid(~energy_type)

```


###  Le graphique de la production mondiale de la nourriture

```{r echo=FALSE}

ggplot(food_world)+
  aes(year, production, fill = Item)+
  geom_col()+
  labs(title = "Production de la nourriture", 
       x = "Année", 
       y = "Production en millions de tonnes")+
  scale_x_continuous(limits = c(1960, 2020),
                     breaks = seq(1960,2020,10))+
  scale_y_continuous(limits = c(0, 10000),
                     breaks = seq(0,10000,1000))+
  theme_dark()

```


### Le graphique de la population mondiale 

```{r echo=FALSE}

ggplot(population_world)+
  aes(year, population_total )+
  geom_col(fill = "LightSeaGreen")+
  labs(title = "Population mondiale", 
       x = "Année", 
       y = "Population en milliards")+
  scale_x_continuous(limits = c(1950, 2020),
                     breaks = seq(1950,2020,10)) +
  scale_y_continuous(limits = c(0, 8),
                     breaks = seq(0,8,1))+
  theme_dark()

```

# Par continent


### Consommation d'energie par source et par type

```{r echo=FALSE}
df_country |> 
  group_by(country, year, energy_source, energy_type, continent, energy_source_consumption) |> 
  summarise(energy = mean(energy_source_consumption, na.rm=TRUE)) |> 
  drop_na(energy) |> 
ggplot()+
  aes(year, energy, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source et type", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,20)) +
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))+
  scale_y_continuous(limits = c(0, 80000),
                     breaks = seq(0,80000,10000))+
  facet_grid(energy_type~continent)

```

### Consommation d'energie par source 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, energy_source, energy_type, energy_source_consumption) |> 
  summarise(energy = mean(energy_source_consumption, na.rm=TRUE)) |> 
  drop_na(energy) |> 
ggplot()+
  aes(year, energy, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,20)) +
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))+
  scale_y_continuous(limits = c(0, 80000),
                     breaks = seq(0,80000,10000))+
  facet_grid(~continent)

```

## Column 2 

###  Le graphique de la production de la nourriture 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, Item, production) |> 
  summarise(production = mean(production, na.rm=TRUE)) |> 
  drop_na(production) |>
ggplot()+
  aes(year, production, fill = Item)+
  geom_col()+
  labs(title = "Production de la nourriture par continent", 
       x = "Année", 
       y = "Production en millions de tonnes")+
  scale_x_continuous(limits = c(1960, 2020),
                     breaks = seq(1960,2020,30))+
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))+
  scale_y_continuous(limits = c(0, 5000),
                     breaks = seq(0, 5000,1000))+
  facet_grid(~continent)

```


### Le graphique de la population 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, population_total) |> 
  summarise(population = mean(population_total, na.rm=TRUE)) |> 
  drop_na(population) |>
ggplot()+
  aes(year, population_total )+
  geom_col(fill = "lightblue")+
  labs(title = "Population par continent", 
       x = "Année", 
       y = "Population en milliards")+
  scale_x_continuous(limits = c(1950, 2020),
                     breaks = seq(1950,2020,20))+
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))+
  # scale_y_continuous(limits = c(0, 5),
  #                    breaks = seq(0,5,1))+
  facet_grid(~continent)

```
  
# Par pays (France)


### Consommation d'energie par source et par type 

```{r echo=FALSE}
df_country |> 
  group_by(country, year, energy_source, energy_type, continent, energy_source_consumption) |> 
  summarise(energy = mean(energy_source_consumption, na.rm=TRUE)) |> 
  drop_na(energy) |>
  filter(country=="France") |> 
ggplot()+
  aes(year, energy, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source et type en France", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,10)) +
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))+
  facet_grid(~energy_type)

```

### Consommation d'energie par source 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, energy_source, energy_type, energy_source_consumption) |> 
  summarise(energy = mean(energy_source_consumption, na.rm=TRUE)) |> 
  drop_na(energy) |>
  filter(country=="France") |> 
ggplot()+
  aes(year, energy, fill = energy_source)+
  geom_col() +
  labs(title = "Consommation d'energie par source en France", 
       x = "Année", 
       y = "Consommation")+
  scale_x_continuous(limits = c(1965, 2020),
                     breaks = seq(1965,2020,10)) +
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))

```


###  Le graphique de la production de la nourriture 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, Item, production) |> 
  summarise(production = mean(production, na.rm=TRUE)) |> 
  drop_na(production) |>
  filter(country=="France") |> 
ggplot()+
  aes(year, production, fill = Item)+
  geom_col()+
  labs(title = "Production de la nourriture en France", 
       x = "Année", 
       y = "Production en millions de tonnes")+
  scale_x_continuous(limits = c(1960, 2020),
                     breaks = seq(1960,2020,10))+
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))

```

### Le graphique de la population 

```{r echo=FALSE}
df_country |> 
  group_by(country, continent, year, population_total) |> 
  summarise(population = mean(population_total, na.rm=TRUE)) |> 
  drop_na(population) |>
  filter(country=="France") |> 
ggplot()+
  aes(year, population_total )+
  geom_col(fill = "orchid")+
  labs(title = "Population en France", 
       x = "Année", 
       y = "Population en milliards")+
  scale_x_continuous(limits = c(1950, 2020),
                     breaks = seq(1950,2020,10))+
  theme_dark()+
  theme(axis.text.x = element_text(size = 10,
                                 angle = 45,
                                 hjust = 1,
                                 vjust = 1))

```
 
# Cartes

```{r CODE CARTE, include=FALSE}
df_total<-read_delim("owid_total.csv") |> 
  filter(year=="2019")

world_map<-map_data("world") |> 
  mutate(iso_code = countrycode(region, 
                                origin = "country.name", 
                                destination = "iso3c")) |> 
  drop_na(iso_code)

df_carte <- world_map |> 
  mutate(group = factor(group),
         region = factor(region)) |> 
  left_join(df_total, by = c("iso_code" = "iso_code"))


```



### La carte de la consommation d'energie 

```{r CARTE1, echo=FALSE}

df_carte |> 
  ggplot()+
  aes(long, lat, group = group)+
  geom_polygon(aes(fill = energy_total))+
  theme_void()+
  theme(plot.background = element_rect(fill="azure"))+
  scale_fill_gradient(high="LightSeaGreen",low="DarkSeaGreen")


```




###  La carte de la production de la nourriture

```{r CARTE2, echo=FALSE}
df_carte |> 
  ggplot()+
  aes(long, lat, group = group)+
  geom_polygon(aes(fill = production_total))+
  theme_void()+
  theme(plot.background = element_rect(fill="lightblue"))+
  scale_fill_gradient(high="darkGreen",low="Green")


```


### La carte de la population 

```{r CARTE3, echo=FALSE}
df_carte |> 
  ggplot()+
  aes(long, lat, group = group)+
  geom_polygon(aes(fill = population_total))+
  theme_void()+
  theme(plot.background = element_rect(fill="lightgreen"))+
  scale_fill_gradient(high="tomato",low="wheat")

```
 

<!--chapter:end:owid_dashboard.Rmd-->

